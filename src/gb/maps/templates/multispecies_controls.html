
    <style>
    .leaflet-container .ms-marker:hover { transform: scale(1.15); box-shadow: 0 1px 6px rgba(0,0,0,0.35); }
    .ms-marker {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      position: relative;
      box-shadow: 0 0 0 rgba(0,0,0,0);
      transition: transform 0.12s ease, box-shadow 0.12s ease;
      outline: 2px solid var(--ms-status-color, #9e9e9e);
      outline-offset: 2px;
      background: var(--ms-marker-fill, #cccccc);
    }
    .gb-report-link {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #1976d2;
      background: #1976d2;
      color: #fff;
      text-decoration: none;
    }
    .leaflet-popup-content a.gb-report-link,
    .leaflet-popup-content a.gb-report-link:visited,
    .leaflet-popup-content a.gb-report-link:hover,
    .leaflet-popup-content a.gb-report-link:focus,
    .leaflet-popup-content a.gb-report-link:active {
      color: #fff !important;
      text-decoration: none !important;
    }
    /* Design tokens for ms-control (easy tuning) */
    :root {
      --ms-width: 380px;
      --ms-max-width-vw: 30vw;
      --ms-padding: 12px;
      --ms-gap: 12px;
      --ms-radius: 8px;
      --ms-bg: #ffffff;
      --ms-border: #e6e6e6;
      --ms-shadow: 0 6px 18px rgba(0,0,0,0.12);
      --ms-accent: #1976d2;
      --ms-focus: #2684ff;
      --ms-safe-top: env(safe-area-inset-top, 0px);
      --ms-safe-right: env(safe-area-inset-right, 0px);
      --ms-safe-bottom: env(safe-area-inset-bottom, 0px);
      --ms-safe-left: env(safe-area-inset-left, 0px);
      --ms-vh: 1vh;
    }
    /* Control box (desktop + mobile pinned top-right) */
    .ms-control {
      position: fixed;
      top: calc(10px + var(--ms-safe-top));
      right: calc(10px + var(--ms-safe-right));
      left: auto;
      background: var(--ms-bg);
      padding: var(--ms-padding);
      border: 1px solid var(--ms-border);
      border-radius: var(--ms-radius);
      z-index: 10002;
      box-shadow: var(--ms-shadow);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      width: var(--ms-width);
      max-width: var(--ms-max-width-vw);
      max-height: min(80vh, calc(var(--ms-vh) * 80));
      overflow: auto;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: var(--ms-gap);
    }
    /* collapsed: show only header (title + filter); keep header fully visible */
    .ms-control.collapsed { height: auto; overflow: visible; }
    .ms-control.collapsed .ms-row,
    .ms-control.collapsed .ms-section { display: none !important; }
    /* when collapsed hide the right-hand info toggle under Filter */
    .ms-control.collapsed .ms-right-header .ms-toggle { display: none !important; }
    .ms-control-header { display:flex; align-items:center; justify-content:space-between; gap:8px; position:sticky; top:0; background: var(--ms-bg); z-index:10003; padding-top:6px; padding-bottom:8px; border-bottom:1px solid rgba(0,0,0,0.06); width:100%; box-sizing:border-box; flex-shrink:0; }
    .ms-control h3 { margin: 0 0 6px 0; font-size: 15px; font-weight: 700; display:inline-block; }
    .ms-title-main { font-size: 15px; font-weight: 700; white-space: nowrap; }
    .ms-title-sub { font-size: 12px; color: #555; margin-top: 2px; }
    .ms-top-header h3 { margin: 0; }
    .ms-top-header { display:flex; align-items:center; gap:8px; }
    .ms-right-header { display:flex; flex-direction:column; align-items:center; gap:6px; }
    .ms-collapse-btn { background: rgba(255,255,255,0.95); border: 1px solid rgba(0,0,0,0.06); font-size: 18px; padding: 8px; cursor: pointer; line-height: 1; position: absolute; top: 6px; right: 6px; z-index: 10010; touch-action: manipulation; -webkit-tap-highlight-color: transparent; pointer-events: auto; border-radius:6px; }
    .ms-open-sheet-btn { font-size:12px; padding:5px 8px; border-radius:6px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    /* ensure top-right filter button matches desktop action widths */
    .ms-open-sheet-btn { min-width: 86px; width: 86px; box-sizing: border-box; }
    .ms-toggle { cursor: pointer; display: inline-flex; align-items: center; gap:8px; font-size:15px; color:#0b66c3; -webkit-user-select: none; user-select: none; }
    .ms-toggle .arrow { display: none; }
    /* Filter button: blue border when control is expanded, transparent when collapsed */
    .ms-control:not(.collapsed) .ms-open-sheet-btn { border-color: var(--ms-accent); box-shadow: 0 6px 18px rgba(25,118,210,0.08); }
    .ms-control.collapsed .ms-open-sheet-btn { border-color: rgba(0,0,0,0.12); box-shadow: none; }
    .ms-control button, .ms-control .ms-open-sheet-btn, .ms-control .ms-toggle { transition: background .15s, box-shadow .12s, transform .08s; touch-action: manipulation; }
    .ms-control button:focus, .ms-control .ms-open-sheet-btn:focus, .ms-control .ms-toggle:focus { outline: 2px solid var(--ms-focus); outline-offset: 2px; }
    .ms-toggle .arrow { display:none !important; transition: transform .15s ease; }
    .ms-toggle.open .arrow { transform: rotate(90deg); }
    .ms-modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.45); z-index:10020; display:flex; align-items:center; justify-content:center; padding: calc(10px + var(--ms-safe-top)) calc(10px + var(--ms-safe-right)) calc(10px + var(--ms-safe-bottom)) calc(10px + var(--ms-safe-left)); box-sizing: border-box; }
    .ms-modal-content { background: #fff; padding: 18px 22px; border-radius:10px; max-width:700px; width:calc(100% - 40px); max-height: calc(var(--ms-vh) * 90); overflow: auto; box-shadow: 0 8px 24px rgba(0,0,0,0.2); position:relative; }
    .ms-modal-close { position:absolute; top:8px; right:8px; border:none; background:transparent; font-size:18px; cursor:pointer; }
    .ms-modal-body { font-size:14px; line-height:1.6; }
    .ms-modal-title { font-weight: 700; }
    .ms-modal-section-title { font-weight: 700; }
    .ms-modal-row { display:flex; gap:16px; align-items:flex-start; margin-top:4px; flex-wrap:wrap; }
    .ms-modal-text { flex:1 1 60%; font-size:15px; line-height:1.5; }
    .ms-modal-image { flex:1 1 30%; display:flex; align-items:flex-start; justify-content:flex-end; }
    .ms-modal-logo-lg { max-width:180px; max-height:120px; height:auto; width:auto; border-radius:6px; }
    /* Bottom-sheet for mobile filters */
    .ms-bottom-sheet { position: fixed; left: 0; right: 0; bottom: 0; max-height: min(80vh, calc(var(--ms-vh) * 80)); background: #fff; box-shadow: 0 -8px 24px rgba(0,0,0,0.18); border-top-left-radius: 12px; border-top-right-radius: 12px; transform: translateY(100%); transition: transform .28s ease; z-index: 10004; overflow: auto; padding-bottom: var(--ms-safe-bottom); box-sizing: border-box; }
    .ms-bottom-sheet.open { transform: translateY(0%); }
    .ms-sheet-header { display:flex; align-items:center; justify-content:space-between; padding: 12px 16px; border-bottom:1px solid #eee; }
    .ms-sheet-handle { width:36px; height:4px; background:#ddd; border-radius:4px; margin:8px auto; }
    .ms-accordion-toggle { width:100%; text-align:left; padding:10px 14px; border:none; background:transparent; font-size:15px; display:flex; align-items:center; justify-content:space-between; cursor:pointer; }
    .ms-accordion-content { padding: 6px 14px 12px 14px; display:none; }
    .ms-accordion-content.open { display:block; }
    .ms-sheet-actions { padding:12px 16px; border-top:1px solid #eee; display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; }
    .ms-sheet-actions button { padding:8px 12px; border-radius:6px; border:1px solid #1976d2; background:#1976d2; color:white; cursor:pointer; min-height: 40px; }
    .ms-control h4 { margin: 0 0 6px 0; font-size: 13px; }
    .ms-section { background:#f7f7f7; border-radius:8px; padding:8px 10px; margin-top:8px; }
    .ms-row { display:flex; flex-wrap:wrap; gap:8px; align-items:flex-start; margin: 6px 0; }
    .ms-filter-option { display:flex; align-items:center; }
    .ms-filter-swatch { display:inline-block; width:12px; height:12px; border-radius:50%; margin:0 0 0 6px; box-sizing:border-box; }
    .ms-filter-swatch-status { background:transparent; border:2px solid transparent; }
    .ms-reset-wrap {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-areas:
        'left info'
        'submit submit';
      gap: 10px;
      align-items: stretch;
    }
    .ms-row-center { display:flex; align-items:center; }
    .ms-row-center-gap8 { display:flex; align-items:center; gap:8px; }
    .ms-col-start-gap6 { display:flex; flex-direction:column; align-items:stretch; gap:8px; grid-area: left; }
    .ms-col-center-gap6 { display:flex; flex-direction:column; align-items:stretch; gap:8px; grid-area: submit; }
    .ms-col-end-gap6 { display:flex; flex-direction:column; align-items:stretch; gap:8px; grid-area: info; justify-content:flex-start; }
    .ms-row-gap8-mt12 { margin-top:12px; display:flex; gap:8px; }
    .ms-row label { font-size: 12px; line-height:1.5; display:flex; align-items:center; flex:0 0 calc(50% - 8px); box-sizing:border-box; }
    .ms-value { margin-left: 10px; font-size: 14px; color: #222; }
    /* custom neutral checkbox: no colored fill, dark-gray checkmark only */
    .ms-control input[type=checkbox] {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border: 1.5px solid rgba(0,0,0,0.35);
      border-radius: 4px;
      background: transparent;
      display: inline-block;
      vertical-align: middle;
      position: relative;
      box-sizing: border-box;
    }
    .ms-control input[type=checkbox]:focus {
      outline: 2px solid rgba(38,132,255,0.18);
      outline-offset: 2px;
    }
    .ms-control input[type=checkbox]:checked::after {
      content: '';
      position: absolute;
      left: 4px;
      top: 1px;
      width: 6px;
      height: 10px;
      border: solid #424242;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
      box-sizing: content-box;
    }
    .ms-all-toggle { display:flex; align-items:center; gap:8px; flex:0 0 100%; margin-bottom:4px; }
    .ms-all-toggle input[type=checkbox] { position:absolute; opacity:0; width:0; height:0; }
    .ms-all-track { width:32px; height:16px; border-radius:999px; background:#ccc; position:relative; flex-shrink:0; transition: background .15s ease; }
    .ms-all-thumb { position:absolute; top:2px; left:2px; width:12px; height:12px; border-radius:50%; background:#fff; box-shadow:0 0 2px rgba(0,0,0,0.4); transition: transform .15s ease; }
    .ms-all-toggle input[type=checkbox]:checked + .ms-all-track { background:#1976d2; }
    .ms-all-toggle input[type=checkbox]:checked + .ms-all-track .ms-all-thumb { transform: translateX(16px); }
    /* small submit button next to help */
    .ms-submit-btn { font-size:13px; padding:6px 8px; border-radius:6px; border:1px solid #1976d2; background:#fff; cursor:pointer; color:#1976d2; }
    .ms-submit-btn:hover { background: #f5fbff; }
    .ms-submit-cta { display:inline-block; padding:6px 10px; border-radius:6px; border:1px solid #1976d2; background:#1976d2; color:#fff; text-decoration:none; }
    .ms-submit-btn-neutral { background:#fff; color:var(--ms-accent); border:1px solid rgba(0,0,0,0.06); }
    .ms-feedback-link { display:inline-flex; align-items:center; gap:6px; padding:6px; border-radius:6px; border:1px solid rgba(0,0,0,0.06); background:#fff; color:var(--ms-accent); }
    .ms-feedback-icon { display:inline-flex; width:14px; height:14px; line-height: 1; }
    .ms-feedback-icon svg { width:14px; height:14px; display:block; fill: currentColor; }
    .ms-feedback-label { margin-left:6px; }
    .ms-more-info-copy-wrap { margin-bottom:4px; }
    .ms-info-btn-inline { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; }
    .ms-info-icon { font-size:14px; line-height:1; color:#fff; }
    .ms-info-label { font-size:12px; color:#fff; }
    .ms-icon-plain-btn { background:none; border:none; padding:0; cursor:pointer; }
    .ms-data-source { margin-top:10px; font-size:11px; color:#555; }

    /* primary blue style for inline info button matching 'Filter anwenden' */
    .ms-info-btn { border: 1px solid var(--ms-accent); background: var(--ms-accent); color: #fff; box-shadow: 0 6px 18px rgba(25,118,210,0.08); }
    .ms-info-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 22px rgba(25,118,210,0.14); }
    .ms-submit-btn.ms-info-btn:hover { background: var(--ms-accent); color: #fff; transform: translateY(-2px); box-shadow: 0 10px 22px rgba(25,118,210,0.14); }
    .ms-info-btn span, .ms-info-btn small { color: #fff; }
    .ms-control button { min-height: 36px; }
    #ms-apply-desktop,
    #ms-reset,
    #ms-submit-btn,
    #ms-more-info-btn,
    #gb-feedback-control {
      width: 100%;
      min-width: 0;
      box-sizing: border-box;
      justify-content: center;
      min-height: 40px;
    }
    .ms-col-center-gap6 { margin-top: 2px; }
    .ms-col-center-gap6 .ms-row-center,
    .ms-col-end-gap6 .ms-row-center,
    .ms-col-end-gap6 .ms-more-info-copy-wrap {
      width: 100%;
    }
    .ms-badge {
      display: none;
      position: absolute;
      right: -4px;
      bottom: -4px;
      background: var(--ms-status-color, #9e9e9e);
      color: #fff;
      border-radius: 8px;
      font-size: 10px;
      line-height: 10px;
      padding: 2px 4px;
    }
    .ms-badge-visible { display: block; }
    .ms-width-match { width: var(--ms-match-width); min-width: var(--ms-match-width); box-sizing: border-box; }
    .ms-hidden { display: none !important; }

    /* Elegant button styles for filter controls */
    #ms-apply-desktop, #ms-apply-filters {
      font-size: 14px;
      padding: 8px 14px;
      border-radius: 10px;
      border: 1px solid transparent;
      background: var(--ms-accent);
      color: #fff;
      box-shadow: 0 4px 14px rgba(25,118,210,0.12);
      cursor: pointer;
      transition: transform .08s ease, box-shadow .12s ease, opacity .12s ease;
      min-width: 120px;
    }
    #ms-apply-desktop:hover, #ms-apply-filters:hover { transform: translateY(-2px); box-shadow: 0 10px 22px rgba(25,118,210,0.14); }
    #ms-reset {
      font-size: 13px;
      padding: 8px 12px;
      border-radius: 10px;
      background: transparent;
      color: var(--ms-accent);
      border: 1px solid rgba(25,118,210,0.14);
      cursor: pointer;
      transition: background .12s ease, transform .06s ease;
      min-width: 120px;
    }
    #ms-reset:hover { background: rgba(25,118,210,0.06); transform: translateY(-1px); }
    /* smaller submit CTA at bottom-right */
    #ms-submit-btn { padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(0,0,0,0.06); background: #fff; color: var(--ms-accent); box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    #ms-submit-btn:hover { box-shadow: 0 6px 18px rgba(0,0,0,0.08); transform: translateY(-1px); }
    .leaflet-marker-icon.ms-div-icon {
      background: transparent !important;
      background-image: none !important;
      border: none !important;
      box-shadow: none !important;
      overflow: visible !important;
    }
    .leaflet-marker-icon.ms-div-icon::before,
    .leaflet-marker-icon.ms-div-icon::after { display: none !important; }
    /* subtle custom scrollbar for the control on desktop */
    .ms-control::-webkit-scrollbar { width: 8px; }
    .ms-control::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); border-radius:6px; }
    @media (max-width: 600px) {
      /* Pin control to top-right on mobile but show compact header and filter button */
      .ms-control { top: calc(10px + var(--ms-safe-top)); right: calc(10px + var(--ms-safe-right)); left: auto; bottom: auto; max-width: calc(100vw - 20px - var(--ms-safe-left) - var(--ms-safe-right)); border-radius: 10px; padding: 8px 10px; }
      .ms-control.ms-overlay-hidden { opacity: 0; transform: translateY(-8px); pointer-events: none; }
      .ms-control-header { align-items: flex-start; gap: 6px; }
      .ms-top-header { flex: 1 1 auto; min-width: 0; }
      .ms-title-main { white-space: normal; overflow-wrap: anywhere; line-height: 1.25; }
      .ms-right-header { flex: 0 0 auto; align-items: flex-end; }
      .ms-control.collapsed { height: auto; overflow: visible; }
      .ms-control.collapsed .ms-row, .ms-control.collapsed .ms-section { display: none !important; }
      .ms-control .ms-toggle { display: none; }
      .ms-control .ms-reset-wrap { display: none; }
      .ms-open-sheet-btn { display:inline-block; width:auto; min-width:0; max-width:100%; }
      /* ensure bottom-sheet is above most elements */
      .ms-bottom-sheet { z-index: 10005; }
      /* Modal layout adjustments for small screens: stack content and center logo */
      .ms-modal-content { max-width: 92vw; width: calc(100% - 24px); max-height: calc(var(--ms-vh) * 88); padding: 14px 16px; }
      .ms-modal-row { flex-direction: column; gap: 12px; }
      .ms-modal-image { flex: 0 0 auto; display:flex; justify-content:center; align-items:center; order: -1; }
      .ms-modal-text { flex: 1 1 100%; }
      .ms-modal-logo-lg { max-width:220px; max-height:140px; margin: 0 auto; }
      #ms-submit-btn-sheet {
        font-size: 12px;
        padding: 6px 10px;
        color: rgba(25,118,210,0.82);
        background: rgba(25,118,210,0.04);
        border-color: rgba(25,118,210,0.18);
        box-shadow: none;
        opacity: 0.9;
      }
      #ms-submit-btn-sheet:hover {
        transform: none;
        box-shadow: none;
        background: rgba(25,118,210,0.08);
      }

      .leaflet-popup-content .gb-desc-list { margin-top: 4px; }
      .leaflet-popup-content .gb-desc-entry { margin: 0.5em 0 0; line-height: 1.45; }
      .leaflet-popup-content .gb-desc-date { font-weight: 700; color: #1f2937; }
      .leaflet-popup-content .gb-desc-plain { margin-top: 4px; line-height: 1.45; }
      .leaflet-popup { max-width: calc(100vw - 16px) !important; }
      .leaflet-popup-content-wrapper { max-height: calc(var(--ms-vh, 1vh) * 78); overflow: hidden; }
      .leaflet-popup-content { max-width: calc(100vw - 48px) !important; max-height: calc(var(--ms-vh, 1vh) * 66); overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; touch-action: pan-y; overflow-wrap: anywhere; word-break: break-word; }
    }
    @media (max-width: 359px) {
      .leaflet-popup { max-width: calc(100vw - 10px) !important; }
      .leaflet-popup-content-wrapper { padding: 4px 6px; border-radius: 10px; }
      .leaflet-popup-content { max-width: calc(100vw - 28px) !important; margin: 8px 8px; font-size: 12px; line-height: 1.35; }
      .leaflet-popup-content b { font-size: 12px; }
    }
    </style>
    <div class="ms-control collapsed" id="ms-control">
        <div class="ms-control-header">
          <div class="ms-top-header">
            <div class="ms-title">
              <div class="ms-title-main">Karte der Gebäudebrüter in Berlin</div>
              <div class="ms-title-sub">Stand: %STAND_DATE%</div>
            </div>
          </div>
          <div class="ms-right-header">
            <div class="ms-row-center-gap8">
                <button id="ms-open-sheet" class="ms-open-sheet-btn" title="Filter öffnen">Filter</button>
              </div>
          </div>
        </div>
      <div class="desktop-only">
        <div class="ms-section">
          <h4>Filter Arten</h4>
          <div class="ms-row" id="ms-species-row"></div>
        </div>
        <div class="ms-section">
          <h4>Filter Status</h4>
          <div class="ms-row" id="ms-status-row"></div>
        </div>
        
        <div class="ms-row ms-reset-wrap">
          <div class="ms-col-start-gap6">
            <button id="ms-apply-desktop" title="Filter anwenden">Filter anwenden</button>
            <button id="ms-reset" title="Alle Marker zeigen">⟲ Filter zurücksetzen</button>
          </div>
          <div class="ms-col-center-gap6">
            <div class="ms-row-center">
              <button id="ms-submit-btn" type="button" class="ms-submit-btn" title="Nistplatz melden">Nistplatz melden</button>
            </div>
          </div>
          <div class="ms-col-end-gap6">
            <div class="ms-more-info-copy-wrap">
              <button id="ms-more-info-btn" class="ms-submit-btn ms-info-btn ms-info-btn-inline" title="Mehr Informationen anzeigen" aria-label="Mehr Informationen anzeigen">
                <span class="ms-info-icon">ⓘ</span>
                <span class="ms-info-label">mehr Infos</span>
              </button>
            </div>
            <div class="ms-row-center">
              <a id="gb-feedback-control" href="mailto:%EMAIL_RECIPIENT%?subject=Feedback%20zur%20Karte%20Geb%C3%A4udebr%C3%BCter%20in%20Berlin" title="Sendet Feedback per E-Mail" aria-label="Sendet Feedback per E-Mail" class="ms-feedback-link"><span class="ms-feedback-icon" aria-hidden="true"><svg viewBox="0 0 24 24" focusable="false"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg></span><span class="ms-feedback-label">Feedback</span></a>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Bottom-sheet for mobile filters -->
    <div id="ms-bottom-sheet" class="ms-bottom-sheet" aria-hidden="true">
      <div class="ms-sheet-handle"></div>
      <div class="ms-sheet-header">
        <strong>Filter</strong>
        <button id="ms-more-info-toggle-sheet" class="ms-toggle ms-icon-plain-btn" title="Mehr Informationen anzeigen"><span>ⓘ ?</span></button>
      </div>
      <div>
        <button class="ms-accordion-toggle" data-target="ms-species-accordion-content">▸ Arten</button>
        <div id="ms-species-accordion-content" class="ms-accordion-content"></div>
        <button class="ms-accordion-toggle" data-target="ms-status-accordion-content">▸ Status</button>
        <div id="ms-status-accordion-content" class="ms-accordion-content"></div>
      </div>
      <div class="ms-sheet-actions">
        <div class="ms-row-center-gap8">
          <button id="ms-apply-filters">Filter anwenden</button>
        </div>
        <div class="ms-row-center-gap8">
          <button id="ms-submit-btn-sheet" type="button" class="ms-submit-btn ms-submit-btn-neutral" title="Nistplatz melden">Nistplatz melden</button>
        </div>
        <div class="ms-row-center-gap8">
          <a id="gb-feedback-mobile" href="mailto:%EMAIL_RECIPIENT%?subject=Feedback%20zur%20Karte%20Geb%C3%A4udebr%C3%BCter%20in%20Berlin" title="Sendet Feedback per E-Mail" aria-label="Sendet Feedback per E-Mail" class="ms-feedback-link"><span class="ms-feedback-icon" aria-hidden="true"><svg viewBox="0 0 24 24" focusable="false"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg></span><span class="ms-feedback-label">Feedback</span></a>
        </div>
      </div>
    </div>
    
    <!-- Info modal (separate from legend) -->
    <div id="ms-info-modal" class="ms-modal ms-hidden">
      <div class="ms-modal-content">
        <button id="ms-info-close" class="ms-modal-close" aria-label="Schließen">✕</button>
        <div class="ms-modal-body">
          <div class="ms-modal-header">
            <h2 class="ms-modal-title">Karte der Gebäudebrüter in Berlin</h2>
          </div>
          <div class="ms-modal-row">
            <div class="ms-modal-text">
              <p>Diese Karte zeigt Standorte von Gebäudebrütern in Berlin. Gebäudebrüter sind Tiere wie Mauersegler, Schwalben, Sperlinge oder Fledermäuse, die an Gebäuden leben.</p>
              <p>Die Markierungen stehen für Häuser, an denen Gebäudebrüter gefunden und gemeldet wurden.</p>
                <p class="ms-data-source">Datenquelle: Online-Datenbank des Projekts Gebäudebrüter der NABU Bezirksgruppe Steglitz-Zehlendorf</p>
            </div>
              <div class="ms-modal-image">
                <img src="docs/images/logo_bgsz.svg" alt="Logo" class="ms-modal-logo-lg" onerror="if(!this.dataset.fallback1){this.dataset.fallback1='1';this.src='images/logo_bgsz.svg';}else{this.onerror=null;this.src='images/Logo%20BezGr%20SteglitzTempelhof%20farb%20%281%29.jpg';}" />
              </div>
          </div>
          
          <h3 class="ms-modal-section-title">Tipps für die Nutzung der Karte</h3>
          <div class="ms-modal-text">
            <p>Setze Filter, um die angezeigten Arten und den Status von Nachweisen gezielt ein- oder auszublenden.</p>
            <p>Klicke in der Karte auf einen Standort-Marker, um weitere Informationen zu den dort erfassten Arten und Maßnahmen zu erhalten.</p>
          </div>
          
        </div>
      </div>
    </div>
    </div>
    <!-- Submit modal (triggered from control button) -->
    <div id="ms-submit-modal" class="ms-modal ms-hidden">
      <div class="ms-modal-content">
        <button id="ms-submit-close" class="ms-modal-close" aria-label="Schließen">✕</button>
        <div class="ms-modal-body">
          <div class="ms-modal-text">
            <p><strong>Kennen Sie einen Nistplatz von Spatz, Schwalbe &amp; Co?</strong></p>
            <p>Dann freuen wir uns über Ihre Meldung! Je mehr Daten wir haben, desto besser können wir die Gebäudebrüter in Berlin schützen.</p>
            <div class="ms-row-gap8-mt12">
              <a id="ms-submit-continue" href="%ONLINE_FORM_URL%" target="_blank" rel="noopener" class="ms-submit-cta">Weiter zum Online-Formular</a>
              <button id="ms-submit-cancel" class="ms-submit-btn">Schließen</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
    (function(){
      try { window.__MS_CONTROLS_READY = true; } catch(e) {}
      var SPECIES_COLORS_JS = %SPECIES_COLORS_JSON%;
      var STATUS_INFO_JS = %STATUS_INFO_JSON%;
      var ALL_SPECIES = Object.keys(SPECIES_COLORS_JS);
      var ALL_STATUS = Object.keys(STATUS_INFO_JS);
      // Cluster-aware filtering support (always AND across groups)
      var MS = { map:null, cluster:null, markers:[], ready:false, userMarker:null, userAccuracyCircle:null, locationBound:false, locationToastTimer:null, locateControl:null, popupVisible:false };
      function syncViewportCssVars(){
        var vh = window.innerHeight || document.documentElement.clientHeight || 0;
        if(vh > 0){
          document.documentElement.style.setProperty('--ms-vh', (vh * 0.01) + 'px');
        }
      }
      function isCompactViewport(){
        try{
          if(window.matchMedia){ return window.matchMedia('(max-width: 600px)').matches; }
        }catch(e){}
        return !!(window.innerWidth && window.innerWidth <= 600);
      }
      function getControlElement(){
        return document.getElementById('ms-control');
      }
      function isModalOpenById(id){
        var modal = document.getElementById(id);
        return !!(modal && !modal.classList.contains('ms-hidden'));
      }
      function hasVisibleMapPopup(){
        if(MS && typeof MS.popupVisible === 'boolean'){ return MS.popupVisible; }
        return !!document.querySelector('.leaflet-popup-pane .leaflet-popup');
      }
      function syncMobileControlVisibility(forceShow){
        var ctrl = getControlElement();
        if(!ctrl){ return; }
        if(!isCompactViewport()){ ctrl.classList.remove('ms-overlay-hidden'); return; }
        if(forceShow === true){ ctrl.classList.remove('ms-overlay-hidden'); return; }
        var shouldHide = isModalOpenById('ms-info-modal') || isModalOpenById('ms-submit-modal') || hasVisibleMapPopup();
        ctrl.classList.toggle('ms-overlay-hidden', shouldHide);
      }
      syncViewportCssVars();
      window.addEventListener('resize', syncViewportCssVars, { passive: true });
      window.addEventListener('orientationchange', syncViewportCssVars, { passive: true });
      window.addEventListener('resize', syncMobileControlVisibility, { passive: true });
      window.addEventListener('orientationchange', syncMobileControlVisibility, { passive: true });
      if(window.visualViewport && typeof window.visualViewport.addEventListener === 'function'){
        window.visualViewport.addEventListener('resize', syncViewportCssVars, { passive: true });
      }
      function resolveMapAndCluster(cb){
        function tryResolve(){
          var mapVarName = Object.keys(window).find(function(k){ return /^map_/.test(k); });
          var map = mapVarName ? window[mapVarName] : null;
          if(!map){ return setTimeout(tryResolve, 150); }
          // ensure zoom control is visible at the map edge
          if(map.zoomControl && typeof map.zoomControl.setPosition === 'function'){
            map.zoomControl.setPosition('bottomright');
          }
          var cluster = null;
          map.eachLayer(function(l){ if(l instanceof L.MarkerClusterGroup){ cluster = l; } });
          if(!cluster){ return setTimeout(tryResolve, 150); }
          cb(map, cluster);
        }
        tryResolve();
      }
      function parseMetaFromIconHtml(html){
        var temp = document.createElement('div'); temp.innerHTML = (html||'').trim();
        var el = temp.querySelector('.ms-marker');
        var species = []; var statuses = []; var statusColor = '#9e9e9e';
        if(el){
          try{ species = JSON.parse(el.getAttribute('data-species')||'[]'); }catch(e){}
          try{ statuses = JSON.parse(el.getAttribute('data-statuses')||'[]'); }catch(e){}
          statusColor = el.getAttribute('data-statuscolor') || '#9e9e9e';
        }
        return { species: species, statuses: statuses, statusColor: statusColor };
      }
      function initMarkers(){
        MS.markers = MS.cluster.getLayers();
        MS.markers.forEach(function(m){
          var html = (m.options && m.options.icon && m.options.icon.options && m.options.icon.options.html) || '';
          m._ms = parseMetaFromIconHtml(html);
        });
        MS.ready = true;
      }
      function removeUserLocationLayers(){
        if(MS.map && MS.userMarker){ try{ MS.map.removeLayer(MS.userMarker); }catch(e){} }
        if(MS.map && MS.userAccuracyCircle){ try{ MS.map.removeLayer(MS.userAccuracyCircle); }catch(e){} }
        MS.userMarker = null;
        MS.userAccuracyCircle = null;
      }
      function updateUserLocationLayers(latlng, accuracy){
        if(!MS.map || !latlng){ return; }
        removeUserLocationLayers();
        try{
          MS.userMarker = L.circleMarker(latlng, {
            radius: 7,
            color: '#ffffff',
            weight: 2,
            fillColor: '#1976d2',
            fillOpacity: 1,
            interactive: false
          }).addTo(MS.map);
          MS.userAccuracyCircle = L.circle(latlng, {
            radius: Math.max(10, Number(accuracy) || 0),
            color: '#1976d2',
            weight: 1,
            fillColor: '#1976d2',
            fillOpacity: 0.12,
            interactive: false
          }).addTo(MS.map);
        }catch(e){}
      }
      function showMobileLocationToast(message){
        if(!isCompactViewport()){ return; }
        var toast = document.getElementById('ms-location-toast');
        if(!toast){
          toast = document.createElement('div');
          toast.id = 'ms-location-toast';
          toast.setAttribute('role', 'status');
          toast.setAttribute('aria-live', 'polite');
          toast.style.position = 'fixed';
          toast.style.left = '50%';
          toast.style.bottom = 'calc(16px + env(safe-area-inset-bottom, 0px))';
          toast.style.transform = 'translate(-50%, 8px)';
          toast.style.maxWidth = 'calc(100vw - 28px)';
          toast.style.padding = '8px 12px';
          toast.style.borderRadius = '10px';
          toast.style.background = 'rgba(33,33,33,0.92)';
          toast.style.color = '#fff';
          toast.style.fontSize = '12px';
          toast.style.lineHeight = '1.35';
          toast.style.zIndex = '10020';
          toast.style.boxShadow = '0 8px 22px rgba(0,0,0,0.22)';
          toast.style.opacity = '0';
          toast.style.transition = 'opacity .18s ease, transform .18s ease';
          document.body.appendChild(toast);
        }
        toast.textContent = message || 'Standort konnte nicht ermittelt werden.';
        toast.style.opacity = '1';
        toast.style.transform = 'translate(-50%, 0)';
        if(MS.locationToastTimer){ clearTimeout(MS.locationToastTimer); }
        MS.locationToastTimer = setTimeout(function(){
          toast.style.opacity = '0';
          toast.style.transform = 'translate(-50%, 8px)';
        }, 3600);
      }
      function ensureLocationBindings(){
        if(!MS.map || MS.locationBound){ return; }
        MS.locationBound = true;
        MS.map.on('locationfound', function(e){
          updateUserLocationLayers(e.latlng, e.accuracy);
        });
        MS.map.on('locationerror', function(e){
          var msg = 'Standort konnte nicht ermittelt werden.';
          if(e && e.code === 1){ msg = 'Standortfreigabe fehlt. Bitte im Browser erlauben.'; }
          else if(e && e.code === 2){ msg = 'Standort derzeit nicht verfügbar.'; }
          else if(e && e.code === 3){ msg = 'Standortabfrage hat zu lange gedauert.'; }
          showMobileLocationToast(msg);
          try{ console.warn('Geolocation unavailable:', e && e.message ? e.message : e); }catch(err){}
        });
      }
      function requestUserLocation(){
        if(!MS.map){ return; }
        if(!navigator.geolocation || typeof MS.map.locate !== 'function'){
          showMobileLocationToast('Standortfunktion wird vom Browser nicht unterstützt.');
          return;
        }
        ensureLocationBindings();
        try{
          MS.map.locate({
            setView: true,
            maxZoom: 17,
            enableHighAccuracy: true,
            timeout: 12000,
            maximumAge: 60000
          });
        }catch(e){}
      }
      function addLocateMapControl(){
        if(!MS.map || MS.locateControl || !L || typeof L.control !== 'function'){ return; }
        var LocateControl = L.Control.extend({
          options: { position: 'bottomright' },
          onAdd: function(){
            var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            var button = L.DomUtil.create('a', '', container);
            button.href = '#';
            button.title = 'Meinen Standort anzeigen';
            button.setAttribute('aria-label', 'Meinen Standort anzeigen');
            button.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false"><path fill="currentColor" d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm8.94 3h-1.99A7.02 7.02 0 0 0 13 5.05V3.06a1 1 0 1 0-2 0v1.99A7.02 7.02 0 0 0 5.05 11H3.06a1 1 0 1 0 0 2h1.99A7.02 7.02 0 0 0 11 18.95v1.99a1 1 0 1 0 2 0v-1.99A7.02 7.02 0 0 0 18.95 13h1.99a1 1 0 1 0 0-2zM12 17a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"></path></svg>';
            button.style.width = '34px';
            button.style.height = '34px';
            button.style.display = 'flex';
            button.style.alignItems = 'center';
            button.style.justifyContent = 'center';
            button.style.background = '#fff';
            button.style.color = '#1976d2';
            button.style.textDecoration = 'none';
            button.style.borderBottom = 'none';
            L.DomEvent.disableClickPropagation(container);
            L.DomEvent.on(button, 'click', function(ev){
              L.DomEvent.stop(ev);
              requestUserLocation();
            });
            return container;
          }
        });
        MS.locateControl = new LocateControl();
        MS.map.addControl(MS.locateControl);
        try{
          var locateEl = MS.locateControl.getContainer && MS.locateControl.getContainer();
          var zoomEl = MS.map.zoomControl && MS.map.zoomControl.getContainer && MS.map.zoomControl.getContainer();
          if(locateEl && zoomEl && locateEl.parentNode && locateEl.parentNode === zoomEl.parentNode){
            locateEl.parentNode.insertBefore(locateEl, zoomEl);
          }
        }catch(e){}
      }
      function autoLocateOnMobile(){
        if(!MS.map || !isCompactViewport()){ return; }
        requestUserLocation();
      }
      // More info modal toggle (desktop + mobile sheet)
      (function(){
        var togDesktop = document.getElementById('ms-more-info-toggle');
        var togSheet = document.getElementById('ms-more-info-toggle-sheet');
        var modal = document.getElementById('ms-info-modal');
        var closeBtn = document.getElementById('ms-info-close');
        var sheet = document.getElementById('ms-bottom-sheet');
        function openModal(ev){
          if(ev){ ev.preventDefault(); }
          if(sheet){ sheet.classList.remove('open'); }
          if(modal){ modal.classList.remove('ms-hidden'); }
          syncMobileControlVisibility();
        }
        function closeModal(){
          if(modal){ modal.classList.add('ms-hidden'); }
          if(sheet){ sheet.classList.remove('open'); }
          syncMobileControlVisibility();
        }
        if(togDesktop){ togDesktop.addEventListener('click', openModal); }
        if(togSheet){ togSheet.addEventListener('click', openModal); }
        // wire any copied desktop toggles or info buttons (e.g., placed near submit button)
        var extraDesktopTogs = document.querySelectorAll('.ms-more-info-toggle-copy, #ms-more-info-btn');
        extraDesktopTogs.forEach(function(t){ t.addEventListener('click', openModal); });
        if(closeBtn){ closeBtn.addEventListener('click', closeModal); }
        if(modal){ modal.addEventListener('click', function(ev){ if(ev.target === modal){ closeModal(); } }); }
      })();

      // Submit modal handlers (open submit modal from control button)
      (function(){
        var submitBtn = document.getElementById('ms-submit-btn');
        var submitModal = document.getElementById('ms-submit-modal');
        var submitClose = document.getElementById('ms-submit-close');
        var submitCancel = document.getElementById('ms-submit-cancel');
        var sheet = document.getElementById('ms-bottom-sheet');
        function openSubmit(ev){ if(ev){ ev.preventDefault(); } if(sheet){ sheet.classList.remove('open'); } if(submitModal){ submitModal.classList.remove('ms-hidden'); } syncMobileControlVisibility(); }
        function closeSubmit(){ if(submitModal){ submitModal.classList.add('ms-hidden'); } syncMobileControlVisibility(); }
        if(submitBtn){ submitBtn.addEventListener('click', openSubmit); }
        var submitSheetBtn = document.getElementById('ms-submit-btn-sheet');
        if(submitSheetBtn){ submitSheetBtn.addEventListener('click', openSubmit); }
        document.addEventListener('click', function(ev){
          var trigger = ev && ev.target && ev.target.closest ? ev.target.closest('#ms-submit-btn, #ms-submit-btn-sheet') : null;
          if(!trigger){ return; }
          openSubmit(ev);
        }, true);
        function isActuallyVisible(el){
          if(!el) return false;
          // getClientRects is empty when display:none or not in layout
          if(!el.getClientRects || el.getClientRects().length === 0) return false;
          var cs;
          try{ cs = window.getComputedStyle(el); }catch(e){ cs = null; }
          if(cs && (cs.display === 'none' || cs.visibility === 'hidden' || cs.opacity === '0')) return false;
          return true;
        }
        function applyMatchedWidth(target, width){
          if(!target || !width) return false;
          var px = Math.round(width);
          if(!px || px < 1) return false;
          target.style.setProperty('--ms-match-width', px + 'px');
          target.classList.add('ms-width-match');
          return true;
        }
        function matchInfoButtonWidth(){
          var s = document.getElementById('gb-feedback-control');
          var i = document.getElementById('ms-more-info-btn');
          if(!isActuallyVisible(s) || !isActuallyVisible(i)) return false;
          var r = s.getBoundingClientRect();
          if(!r || r.width < 80) return false;
          return applyMatchedWidth(i, r.width);
        }
        function matchApplyButtonWidth(){
          var reset = document.getElementById('ms-reset');
          var apply = document.getElementById('ms-apply-desktop');
          if(!isActuallyVisible(reset) || !isActuallyVisible(apply)) return false;
          var r = reset.getBoundingClientRect();
          if(!r || r.width < 120) return false;
          return applyMatchedWidth(apply, r.width);
        }
        function scheduleButtonSizing(){
          // run over a few frames so layout/fonts settle
          var frames = 0;
          function tick(){
            frames++;
            matchApplyButtonWidth();
            matchInfoButtonWidth();
            if(frames < 6) requestAnimationFrame(tick);
          }
          requestAnimationFrame(tick);
        }
        // run once in case control starts expanded; otherwise we trigger on expand
        scheduleButtonSizing();
        window.addEventListener('resize', scheduleButtonSizing);
        if(submitClose){ submitClose.addEventListener('click', closeSubmit); }
        if(submitCancel){ submitCancel.addEventListener('click', closeSubmit); }
        if(submitModal){ submitModal.addEventListener('click', function(ev){ if(ev.target === submitModal){ closeSubmit(); } }); }
      })();
      function intersection(a, b){ return a.filter(function(x){ return b.indexOf(x) !== -1; }); }
      function applyMatchedWidthSafe(target, width){
        if(!target || !width) return false;
        var px = Math.round(width);
        if(!px || px < 1) return false;
        target.style.setProperty('--ms-match-width', px + 'px');
        target.classList.add('ms-width-match');
        return true;
      }
      function computeGradient(species){
        if(!species || !species.length){ return '#cccccc'; }
        var n = Math.min(species.length, 4);
        var seg = 360 / n;
        var stops = [];
        for(var i=0;i<n;i++){
          var sp = species[i];
          var color = SPECIES_COLORS_JS[sp] || '#9e9e9e';
          var start = (i*seg).toFixed(2);
          var end = ((i+1)*seg).toFixed(2);
          stops.push(color + ' ' + start + 'deg ' + end + 'deg');
        }
        return 'conic-gradient(' + stops.join(', ') + ')';
      }
      function applyVisualsToMarker(m, selectedSpecies, selectedStatus, speciesAll, statusAll){
        var sp = m._ms.species || [];
        var st = m._ms.statuses || [];
        var spSel = speciesAll ? sp : (selectedSpecies.length ? intersection(sp, selectedSpecies) : []);
        var el = m._icon;
        var inner = el ? el.querySelector('.ms-marker') : null;
        if(inner){
          inner.style.background = computeGradient(spSel);
          var hasNoStatus = !st || st.length === 0;
          var wantsNoStatus = selectedStatus.indexOf('none') !== -1;
          var stSel = statusAll ? st : (selectedStatus.length ? intersection(st, selectedStatus) : []);
          var color = 'transparent';
          if(statusAll){
            color = m._ms.statusColor || '#9e9e9e';
          } else if(stSel.length){
            var key = stSel[0];
            color = (STATUS_INFO_JS[key] && STATUS_INFO_JS[key].color) || (m._ms.statusColor || '#9e9e9e');
          } else if(wantsNoStatus && hasNoStatus){
            color = (STATUS_INFO_JS['none'] && STATUS_INFO_JS['none'].color) || (m._ms.statusColor || '#9e9e9e');
          }
          inner.style.outline = '2px solid ' + color;
          var badge = inner.querySelector('.ms-badge'); if(badge){ badge.classList.toggle('ms-badge-visible', !!stSel.length); badge.style.background = color; }
        }
      }
      function rebuildCluster(selectedSpecies, selectedStatus){
        if(!MS.ready){ return; }
        MS.cluster.clearLayers();
        var speciesAll = selectedSpecies.length === ALL_SPECIES.length;
        var statusAll = selectedStatus.length === ALL_STATUS.length;
        var toAdd = [];
        for(var i=0;i<MS.markers.length;i++){
          var m = MS.markers[i];
          var sp = m._ms.species || [];
          var st = m._ms.statuses || [];
          // Group semantics:
          // - none selected => show nothing
          // - all selected => do not restrict (also includes markers with empty st/sp)
          // - subset selected => restrict to intersection
          var speciesAllows = speciesAll ? true : (selectedSpecies.length ? intersection(sp, selectedSpecies).length > 0 : false);
          var hasNoStatus = !st || st.length === 0;
          var wantsNoStatus = selectedStatus.indexOf('none') !== -1;
          var statusAllows = statusAll ? true : (
            selectedStatus.length ? (
              (wantsNoStatus && hasNoStatus) || intersection(st, selectedStatus).length > 0
            ) : false
          );
          var visible = speciesAllows && statusAllows;
          if(visible){ toAdd.push(m); }
        }
        toAdd.forEach(function(m){ MS.cluster.addLayer(m); });
        setTimeout(function(){ MS.cluster.getLayers().forEach(function(m){ applyVisualsToMarker(m, selectedSpecies, selectedStatus, speciesAll, statusAll); }); }, 75);
      }
      // build filter checkboxes into desktop and bottom-sheet accordions
      function buildFilters(){
        var sRow = document.getElementById('ms-species-row');
        var sAccordion = document.getElementById('ms-species-accordion-content');
        var stRow = document.getElementById('ms-status-row');
        var stAccordion = document.getElementById('ms-status-accordion-content');
        if(!sRow || !sAccordion || !stRow || !stAccordion) return;
        sRow.innerHTML = ''; sAccordion.innerHTML = '';
        stRow.innerHTML = ''; stAccordion.innerHTML = '';
        // 'Alle' for species
        function makeAllCheckbox(id){
          var wrap = document.createElement('label');
          wrap.className = 'ms-all-toggle';
          var cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.id = id;
          cb.checked = true;
          var track = document.createElement('span');
          track.className = 'ms-all-track';
          var thumb = document.createElement('span');
          thumb.className = 'ms-all-thumb';
          track.appendChild(thumb);
          var text = document.createElement('span');
          text.textContent = 'Alle';
          wrap.appendChild(cb);
          wrap.appendChild(track);
          wrap.appendChild(text);
          return {wrap: wrap, input: cb};
        }
        var sAllDesktop = makeAllCheckbox('ms-species-all'); sRow.appendChild(sAllDesktop.wrap);
        var sAllSheet = makeAllCheckbox('ms-species-all-sheet'); sAccordion.appendChild(sAllSheet.wrap);
        Object.keys(SPECIES_COLORS_JS).forEach(function(name){
          function makeEntry(prefix){
            var id = prefix + '-' + name;
            var wrap = document.createElement('label'); wrap.className = 'ms-filter-option';
            var cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = name; cb.id = id; cb.className = 'ms-filter-species'; cb.checked = true;
              var swatch = document.createElement('span'); swatch.className = 'ms-filter-swatch'; swatch.style.background = SPECIES_COLORS_JS[name];
            wrap.appendChild(cb);
            var value = document.createElement('span'); value.className = 'ms-value'; value.textContent = name;
            wrap.appendChild(value);
            wrap.appendChild(swatch);
            return wrap;
          }
          sRow.appendChild(makeEntry('ms-sp'));
          sAccordion.appendChild(makeEntry('ms-sp-sheet'));
        });
        // 'Alle' for status
        var stAllDesktop = makeAllCheckbox('ms-status-all'); stRow.appendChild(stAllDesktop.wrap);
        var stAllSheet = makeAllCheckbox('ms-status-all-sheet'); stAccordion.appendChild(stAllSheet.wrap);
        Object.keys(STATUS_INFO_JS).forEach(function(key){
          var info = STATUS_INFO_JS[key];
          function makeEntry(prefix){
            var id = prefix + '-' + key;
            var wrap = document.createElement('label'); wrap.className = 'ms-filter-option';
            var cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = key; cb.id = id; cb.className = 'ms-filter-status'; cb.checked = true;
            var swatch = document.createElement('span'); swatch.className = 'ms-filter-swatch ms-filter-swatch-status'; swatch.style.borderColor = info.color;
            wrap.appendChild(cb);
            var value = document.createElement('span'); value.className = 'ms-value'; value.textContent = info.label;
            wrap.appendChild(value);
            wrap.appendChild(swatch);
            return wrap;
          }
          stRow.appendChild(makeEntry('ms-st'));
          stAccordion.appendChild(makeEntry('ms-st-sheet'));
        });
      }
      function applyFilters(){
        var selectedSpecies = Array.from(document.querySelectorAll('.ms-filter-species:checked')).map(function(el){ return el.value; });
        var selectedStatus = Array.from(document.querySelectorAll('.ms-filter-status:checked')).map(function(el){ return el.value; });
        if(!MS.ready){ setTimeout(function(){ rebuildCluster(selectedSpecies, selectedStatus); }, 150); }
        else { rebuildCluster(selectedSpecies, selectedStatus); }
      }
      function wireFilters(){
        // sync desktop and sheet 'Alle' boxes and checkboxes by class
        document.addEventListener('change', function(ev){ if(ev.target && ev.target.classList){ if(ev.target.classList.contains('ms-filter-species') || ev.target.classList.contains('ms-filter-status')){ var boxes = Array.from(document.querySelectorAll(ev.target.tagName+'[value]')).filter(function(x){ return x.value === ev.target.value && x !== ev.target; }); boxes.forEach(function(b){ b.checked = ev.target.checked; }); }
          // sync 'Alle' behavior
          if(ev.target.id === 'ms-species-all' || ev.target.id === 'ms-species-all-sheet'){ var check = ev.target.checked; document.querySelectorAll('#ms-species-row input[type=checkbox], #ms-species-accordion-content input[type=checkbox]').forEach(function(cb){ if(cb !== ev.target) cb.checked = check; }); }
          if(ev.target.id === 'ms-status-all' || ev.target.id === 'ms-status-all-sheet'){ var check = ev.target.checked; document.querySelectorAll('#ms-status-row input[type=checkbox], #ms-status-accordion-content input[type=checkbox]').forEach(function(cb){ if(cb !== ev.target) cb.checked = check; }); }
        }});
      }
       // wire controls (desktop: expand/collapse box via Filter, explicit 'Filter anwenden'; mobile: open sheet)
      document.addEventListener('click', function(ev){
        var openBtn = document.getElementById('ms-open-sheet');
        var sheet = document.getElementById('ms-bottom-sheet');
        var ctrl = document.getElementById('ms-control');
        var openBtnClicked = false;
        if(openBtn && ev.target){
          if(ev.target === openBtn){
            openBtnClicked = true;
          } else if(ev.target.closest && ev.target.closest('#ms-open-sheet')){
            openBtnClicked = true;
          }
        }
        // Filter button toggles desktop box or opens mobile sheet
        if(openBtnClicked){
          syncMobileControlVisibility(true);
          if(isCompactViewport()){
            if(sheet){
              sheet.classList.toggle('open');
              if(!sheet.classList.contains('open')){ syncMobileControlVisibility(); }
            }
          } else {
            if(ctrl){
              ctrl.classList.toggle('collapsed');
              // after expanding, re-run sizing so widths are measured when visible
              if(!ctrl.classList.contains('collapsed')){
                try{ if(window.requestAnimationFrame){ requestAnimationFrame(function(){ requestAnimationFrame(function(){
                  var btn = document.getElementById('gb-feedback-control');
                  var info = document.getElementById('ms-more-info-btn');
                  var reset = document.getElementById('ms-reset');
                  var apply = document.getElementById('ms-apply-desktop');
                  if(btn && info){ var r1 = btn.getBoundingClientRect(); if(r1 && r1.width > 80){ applyMatchedWidthSafe(info, r1.width); } }
                  if(reset && apply){ var r2 = reset.getBoundingClientRect(); if(r2 && r2.width > 120){ applyMatchedWidthSafe(apply, r2.width); } }
                }); }); } }catch(e){}
              }
            }
          }
        }
        // apply buttons
        if(ev.target && (ev.target.id === 'ms-apply-filters' || ev.target.id === 'ms-apply-desktop')){
          applyFilters();
          if(sheet && ev.target.id === 'ms-apply-filters'){ sheet.classList.remove('open'); }
        }
        // accordion toggles in bottom sheet
        if(ev.target && ev.target.classList && ev.target.classList.contains('ms-accordion-toggle')){
          var t = ev.target.getAttribute('data-target');
          var node = document.getElementById(t);
          if(node){ node.classList.toggle('open'); }
        }
      });
      // reset button
      document.addEventListener('click', function(ev){
        if(ev.target && ev.target.id === 'ms-reset'){
          // re-activate all species/status checkboxes
          document.querySelectorAll('.ms-filter-species, .ms-filter-status').forEach(function(el){ el.checked = true; });
          // re-activate "Alle" toggles in desktop + sheet
          document.querySelectorAll('#ms-species-all, #ms-species-all-sheet, #ms-status-all, #ms-status-all-sheet').forEach(function(el){ el.checked = true; });
          var selectedSpecies = Object.keys(SPECIES_COLORS_JS);
          var selectedStatus = Object.keys(STATUS_INFO_JS);
          rebuildCluster(selectedSpecies, selectedStatus);
        }
      });
      // close bottom sheet when tapping backdrop
      (function(){
        var sheet = document.getElementById('ms-bottom-sheet');
        if(!sheet) return;
        sheet.addEventListener('click', function(ev){ if(ev.target === sheet){ sheet.classList.remove('open'); } });
        // also close sheet when tapping the map area (leaflet container) or touching outside the sheet
        function closeIfMapTap(ev){
          try{
            if(!sheet.classList.contains('open')) return;
            var target = ev.target || window.event && window.event.srcElement;
            if(!target) return;
            // if tap/click occurred inside the sheet, ignore
            if(target.closest && target.closest('.ms-bottom-sheet')) return;
            // if tap/click occurred inside a leaflet map container, close the sheet
            if(target.closest && target.closest('.leaflet-container')){ sheet.classList.remove('open'); }
          }catch(e){}
        }
        document.addEventListener('click', closeIfMapTap, {passive:true});
        document.addEventListener('touchstart', closeIfMapTap, {passive:true});
      })();
      // initial pass
      resolveMapAndCluster(function(map, cluster){
        MS.map = map;
        MS.cluster = cluster;
        try{
          if(MS.map && MS.map.options){ MS.map.options.closePopupOnClick = false; }
        }catch(e){}
        initMarkers();
        addLocateMapControl();
        if(MS.map && typeof MS.map.on === 'function'){
          MS.map.on('popupopen', function(e){
            MS.popupVisible = true; syncMobileControlVisibility();
            try{
              if(e && e.popup && e.popup.options){
                e.popup.options.closeOnClick = false;
                e.popup.options.autoClose = false;
              }
              var popupEl = null;
              if(e && e.popup){
                if(typeof e.popup.getElement === 'function'){ popupEl = e.popup.getElement(); }
                else if(e.popup._container){ popupEl = e.popup._container; }
              }
              if(!popupEl){ popupEl = document.querySelector('.leaflet-popup'); }
              var viewportH = 0;
              try{
                viewportH = (window.visualViewport && window.visualViewport.height) ? window.visualViewport.height : (window.innerHeight || document.documentElement.clientHeight || 0);
              }catch(err){ viewportH = (window.innerHeight || 0); }
              if(popupEl && viewportH > 0){
                var popupWrapper = popupEl.querySelector('.leaflet-popup-content-wrapper');
                var popupContent = popupEl.querySelector('.leaflet-popup-content');
                var wrapperMax = Math.max(180, Math.floor(viewportH * 0.78));
                var contentMax = Math.max(140, Math.floor(viewportH * 0.66));
                if(popupWrapper){
                  popupWrapper.style.maxHeight = wrapperMax + 'px';
                  popupWrapper.style.overflow = 'hidden';
                }
                if(popupContent){
                  popupContent.style.maxHeight = contentMax + 'px';
                  popupContent.style.overflowY = 'auto';
                  popupContent.style.overflowX = 'hidden';
                  popupContent.style.webkitOverflowScrolling = 'touch';
                  popupContent.style.overscrollBehavior = 'contain';
                  popupContent.style.touchAction = 'pan-y';
                }
              }
              if(popupEl && window.L && L.DomEvent){
                try{ L.DomEvent.disableClickPropagation(popupEl); }catch(err){}
                try{ L.DomEvent.disableScrollPropagation(popupEl); }catch(err){}
              }
              if(popupEl){
                ['touchstart','touchmove','touchend','pointerdown','pointermove','wheel'].forEach(function(evName){
                  try{ popupEl.addEventListener(evName, function(ev){ ev.stopPropagation(); }, { passive: false }); }catch(err){}
                });
              }
            }catch(err){}
          });
          MS.map.on('popupclose', function(){ MS.popupVisible = false; setTimeout(syncMobileControlVisibility, 0); });
          MS.map.on('click', function(ev){
            try{
              var target = ev && ev.originalEvent ? ev.originalEvent.target : null;
              if(!target){ return; }
              if(target.closest && target.closest('.leaflet-popup')){ return; }
              if(target.closest && target.closest('.leaflet-container')){
                if(MS.map && typeof MS.map.closePopup === 'function'){ MS.map.closePopup(); }
              }
            }catch(err){}
            setTimeout(function(){
              if(!document.querySelector('.leaflet-popup-pane .leaflet-popup')){
                MS.popupVisible = false;
                syncMobileControlVisibility();
              }
            }, 0);
          });
        }
        syncMobileControlVisibility();
        autoLocateOnMobile();
      });
      buildFilters();
      wireFilters();
      setTimeout(function(){ var selectedSpecies = Object.keys(SPECIES_COLORS_JS); var selectedStatus = Object.keys(STATUS_INFO_JS); rebuildCluster(selectedSpecies, selectedStatus); }, 250);
    })();
     </script>
    <script>
    (function(){
      var SPECIES_COLORS_FALLBACK = %SPECIES_COLORS_JSON%;
      var STATUS_INFO_FALLBACK = %STATUS_INFO_JSON%;
      function isCompactViewport(){
        try{
          if(window.matchMedia){ return window.matchMedia('(max-width: 600px)').matches; }
        }catch(e){}
        return !!(window.innerWidth && window.innerWidth <= 600);
      }
      function bindBasicFallback(){
        var btn = document.getElementById('ms-open-sheet');
        var ctrl = document.getElementById('ms-control');
        var sheet = document.getElementById('ms-bottom-sheet');
        if(!btn || !ctrl || !sheet || btn.dataset.fallbackBound === '1'){ return false; }
        btn.dataset.fallbackBound = '1';
        btn.addEventListener('click', function(ev){
          if(ev){ ev.preventDefault(); }
          if(isCompactViewport()){
            sheet.classList.toggle('open');
          } else {
            ctrl.classList.toggle('collapsed');
          }
        });
        document.addEventListener('click', function(ev){
          if(ev.target && ev.target.classList && ev.target.classList.contains('ms-accordion-toggle')){
            var targetId = ev.target.getAttribute('data-target');
            var node = document.getElementById(targetId);
            if(node){ node.classList.toggle('open'); }
          }
        });
        return true;
      }
      function ensureFallbackFilterOptions(){
        if(window.__MS_CONTROLS_READY){ return; }
        var sRow = document.getElementById('ms-species-row');
        var sAccordion = document.getElementById('ms-species-accordion-content');
        var stRow = document.getElementById('ms-status-row');
        var stAccordion = document.getElementById('ms-status-accordion-content');
        if(!sRow || !sAccordion || !stRow || !stAccordion){ return; }
        if(sRow.querySelector('.ms-filter-species') || stRow.querySelector('.ms-filter-status')){ return; }
        function appendOption(container, cssClass, value, labelText){
          var wrap = document.createElement('label');
          wrap.className = 'ms-filter-option';
          var cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.className = cssClass;
          cb.value = value;
          cb.checked = true;
          var label = document.createElement('span');
          label.className = 'ms-value';
          label.textContent = labelText;
          wrap.appendChild(cb);
          wrap.appendChild(label);
          container.appendChild(wrap);
        }
        Object.keys(SPECIES_COLORS_FALLBACK).forEach(function(name){
          appendOption(sRow, 'ms-filter-species', name, name);
          appendOption(sAccordion, 'ms-filter-species', name, name);
        });
        Object.keys(STATUS_INFO_FALLBACK).forEach(function(key){
          var info = STATUS_INFO_FALLBACK[key] || { label: key };
          appendOption(stRow, 'ms-filter-status', key, info.label || key);
          appendOption(stAccordion, 'ms-filter-status', key, info.label || key);
        });
      }
      function tryLoadControlsScript(done){
        var candidates = [
          'assets/js/map-controls.js',
          'docs/assets/js/map-controls.js'
        ];
        var index = 0;
        function next(){
          if(window.__MS_CONTROLS_READY){ return done(true); }
          if(index >= candidates.length){ return done(false); }
          var src = candidates[index++] + '?v=' + Date.now();
          var script = document.createElement('script');
          var settled = false;
          function finalize(ok){
            if(settled){ return; }
            settled = true;
            script.onerror = null;
            script.onload = null;
            if(ok || window.__MS_CONTROLS_READY){ done(true); }
            else { next(); }
          }
          script.onload = function(){ setTimeout(function(){ finalize(!!window.__MS_CONTROLS_READY); }, 120); };
          script.onerror = function(){ finalize(false); };
          script.src = src;
          document.head.appendChild(script);
          setTimeout(function(){ finalize(!!window.__MS_CONTROLS_READY); }, 1800);
        }
        next();
      }
      function initResilientFallback(){
        if(window.__MS_CONTROLS_READY){ return; }
        tryLoadControlsScript(function(ok){
          if(ok || window.__MS_CONTROLS_READY){ return; }
          bindBasicFallback();
          ensureFallbackFilterOptions();
        });
      }
      if(document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', initResilientFallback);
      } else {
        initResilientFallback();
      }
      setTimeout(initResilientFallback, 900);
    })();
    </script>
    
